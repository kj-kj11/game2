<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‹ã˜ã“ã˜ã‚²ãƒ¼ãƒ  - ä½“å†…æ™‚è¨ˆã‚²ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #ffffff;
      color: #222;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }

    .title-area {
      text-align: center;
      margin: 8px 0 14px;
    }

    .title-logo {
      max-width: 280px;
      width: 80%;
      height: auto;
      image-rendering: -webkit-optimize-contrast;
      display: block;
      margin: 0 auto 4px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.25));
    }

    .subtitle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-indent: 0.12em;
      color: #111; /* é»’æ–‡å­— */
      margin-top: 4px;
    }

    .subtitle-icon {
      font-size: 1.3rem;
    }

    section {
      background: #ffffff;
      border-radius: 24px;
      padding: 18px 16px 20px;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.15);
      border: 2px solid transparent;
      background-image:
        linear-gradient(#ffffff, #ffffff),
        linear-gradient(135deg, #ff8a65, #ffca28, #4fc3f7, #ba68c8);
      background-origin: border-box;
      background-clip: padding-box, border-box; /* ã‚«ãƒ©ãƒ•ãƒ«ãªæ ç·š */
    }

    .hidden {
      display: none;
    }

    label {
      display: block;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 2px solid #e5e7eb;
      font-size: 0.95rem;
      outline: none;
      transition: box-shadow 0.15s, border-color 0.15s, transform 0.05s;
      background: #f9fafb;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: #ff8a65;
      box-shadow: 0 0 0 2px rgba(255, 138, 101, 0.35);
      background: #ffffff;
    }

    .names-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .name-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
    }

    .name-row span {
      min-width: 4em;
      color: #4b5563;
      font-weight: 600;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 11px 16px;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.03em;
      transition: transform 0.08s ease, box-shadow 0.08s ease,
        opacity 0.1s ease;
      box-shadow: 0 10px 22px rgba(255, 111, 97, 0.45);
      background: linear-gradient(135deg, #ff6f61, #ffb86c);
      color: #fff;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 13px 26px rgba(255, 111, 97, 0.6);
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 6px 12px rgba(255, 111, 97, 0.6);
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #e0f2fe, #fce7f3);
      color: #1f2933;
      box-shadow: 0 8px 18px rgba(148, 163, 184, 0.4);
    }

    .btn-secondary:hover {
      box-shadow: 0 10px 22px rgba(148, 163, 184, 0.55);
    }

    .btn-inline-group {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .btn-inline-group .btn {
      width: 50%;
    }

    .small-note {
      font-size: 0.78rem;
      color: #6b7280;
      margin-top: 6px;
    }

    /* Game screen */
    .status-line {
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: #6b7280;
      font-weight: 600;
    }

    .current-player {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 10px;
      color: #111827;
    }

    .target-box {
      margin: 8px 0 10px;
      padding: 12px;
      border-radius: 18px;
      background: linear-gradient(135deg, #e0f2fe, #fef9c3);
      border: 1px solid rgba(148, 163, 184, 0.4);
      text-align: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: #1f2933;
    }

    .target-box span {
      font-size: 1.6rem;
      color: #2563eb;
    }

    .instruction {
      font-size: 0.9rem;
      margin: 4px 0 12px;
      color: #374151;
    }

    .result-box {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
      font-size: 0.92rem;
      min-height: 44px;
    }

    .result-highlight {
      font-weight: 700;
      font-size: 1rem;
    }

    .result-sub {
      font-size: 0.84rem;
      color: #6b7280;
      margin-top: 2px;
    }

    /* Roulette screen */
    .roulette-circle {
      width: 210px;
      height: 210px;
      border-radius: 50%;
      margin: 10px auto;
      background: conic-gradient(
        #ff8a65,
        #ffca28,
        #4fc3f7,
        #ba68c8,
        #ff8a65
      );
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.25);
      position: relative;
    }

    .roulette-inner {
      width: 152px;
      height: 152px;
      border-radius: 50%;
      background: radial-gradient(circle at top, #ffffff, #f9fafb);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      border: 3px solid rgba(148, 163, 184, 0.5);
    }

    .roulette-number {
      font-size: 3.1rem;
      font-weight: 800;
      color: #111827;
    }

    .roulette-label {
      font-size: 0.9rem;
      margin-top: 4px;
      color: #6b7280;
    }

    .pointer {
      width: 0;
      height: 0;
      border-left: 16px solid transparent;
      border-right: 16px solid transparent;
      border-bottom: 26px solid #111827;
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      filter: drop-shadow(0 4px 4px rgba(15, 23, 42, 0.4));
    }

    .roulette-message {
      text-align: center;
      font-size: 0.9rem;
      margin-top: 8px;
      color: #374151;
    }

    /* Result screen */
    .result-header {
      text-align: center;
      margin-bottom: 14px;
      position: relative;
      padding-top: 6px;
      padding-bottom: 6px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0f2fe;
      color: #2563eb;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .winner-title {
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .winner-name {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 0.12em;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.9),
        0 0 24px rgba(59, 130, 246, 0.9);
      animation: winner-pop 0.8s ease-out alternate infinite;
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      background: radial-gradient(circle at top, #2563eb, #f97316);
      color: #fff;
    }

    .winner-caption {
      font-size: 0.9rem;
      margin-top: 8px;
      color: #4b5563;
    }

    .confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      border-radius: inherit;
    }

    .confetti span {
      position: absolute;
      width: 6px;
      height: 12px;
      border-radius: 4px;
      background: linear-gradient(135deg, #f97316, #facc15);
      opacity: 0.95;
      animation: confetti-fall 1.8s linear infinite;
    }

    .confetti span:nth-child(1) {
      left: 10%;
      animation-delay: -0.2s;
    }
    .confetti span:nth-child(2) {
      left: 25%;
      animation-delay: -0.4s;
      background: linear-gradient(135deg, #22c55e, #a3e635);
    }
    .confetti span:nth-child(3) {
      left: 45%;
      animation-delay: -0.8s;
      background: linear-gradient(135deg, #3b82f6, #22d3ee);
    }
    .confetti span:nth-child(4) {
      left: 65%;
      animation-delay: -1.1s;
      background: linear-gradient(135deg, #ec4899, #f97316);
    }
    .confetti span:nth-child(5) {
      left: 82%;
      animation-delay: -1.4s;
      background: linear-gradient(135deg, #6366f1, #a855f7);
    }

    @keyframes confetti-fall {
      0% {
        transform: translate3d(0, -140%, 0) rotateZ(0deg);
      }
      100% {
        transform: translate3d(0, 140%, 0) rotateZ(260deg);
      }
    }

    @keyframes winner-pop {
      0% {
        transform: scale(1);
      }
      100% {
        transform: scale(1.07) rotate(-1deg);
      }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      margin: 8px 0 10px;
      background: #f9fafb;
      border-radius: 12px;
      overflow: hidden;
    }

    thead {
      background: #e5e7eb;
    }

    th,
    td {
      padding: 6px 6px;
      text-align: center;
    }

    tbody tr:nth-child(odd) {
      background: #ffffff;
    }

    tbody tr:nth-child(even) {
      background: #f3f4f6;
    }

    tbody tr.highlight {
      background: #fef9c3;
      font-weight: 600;
    }

    .footer-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .footer-buttons .btn {
      flex: 1 1 48%;
      min-width: 0;
    }

    @media (max-width: 420px) {
      section {
        padding: 14px 12px 16px;
      }

      .btn-inline-group {
        flex-direction: column;
      }

      .btn-inline-group .btn {
        width: 100%;
      }

      .footer-buttons {
        flex-direction: column;
      }

      .footer-buttons .btn {
        width: 100%;
      }

      .title-logo {
        max-width: 240px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title-area">
      <img
        src="kajikoji_logo_main.png"
        alt="ã‹ã˜ã“ã˜ã‚²ãƒ¼ãƒ "
        class="title-logo"
      />
      <div class="subtitle">
        <span class="subtitle-icon">â±</span>ä½“å†…æ™‚è¨ˆã‚²ãƒ¼ãƒ 
      </div>
    </div>

    <!-- è¨­å®šç”»é¢ -->
    <section id="setup-screen">
      <label for="player-count">ãƒ—ãƒ¬ã‚¤äººæ•°ï¼ˆ1ã€œ6äººï¼‰</label>
      <select id="player-count">
        <option value="1">1äºº</option>
        <option value="2" selected>2äºº</option>
        <option value="3">3äºº</option>
        <option value="4">4äºº</option>
        <option value="5">5äºº</option>
        <option value="6">6äºº</option>
      </select>

      <div class="small-note">
        ãã‚Œãã‚Œã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºæ¬„ã¯ã€Œãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã€ãªã©è‡ªå‹•ã§å…¥ã‚Šã¾ã™ï¼‰
      </div>

      <div class="names-grid" id="names-grid">
        <div class="name-row" data-index="1">
          <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1</span>
          <input
            type="text"
            id="player-name-1"
            placeholder="åå‰ï¼ˆä¾‹ï¼šã‹ã˜ã“ã˜ï¼‰"
          />
        </div>
        <div class="name-row" data-index="2">
          <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2</span>
          <input
            type="text"
            id="player-name-2"
            placeholder="åå‰ï¼ˆä¾‹ï¼šã•ã‚“ï¼‰"
          />
        </div>
        <div class="name-row" data-index="3">
          <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3</span>
          <input type="text" id="player-name-3" placeholder="åå‰" />
        </div>
        <div class="name-row" data-index="4">
          <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4</span>
          <input type="text" id="player-name-4" placeholder="åå‰" />
        </div>
        <div class="name-row" data-index="5">
          <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼5</span>
          <input type="text" id="player-name-5" placeholder="åå‰" />
        </div>
        <div class="name-row" data-index="6">
          <span>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼6</span>
          <input type="text" id="player-name-6" placeholder="åå‰" />
        </div>
      </div>

      <div style="margin-top: 14px">
        <button class="btn" id="start-game-btn">
          ãŠé¡Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã¸ â–¶
        </button>
      </div>
    </section>

    <!-- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç”»é¢ -->
    <section id="roulette-screen" class="hidden">
      <div class="status-line">ã‚¹ãƒ†ãƒƒãƒ— 2 / 3ï¼šãŠé¡Œã‚’æ±ºã‚ã‚ˆã†ï¼</div>
      <div class="roulette-circle">
        <div class="pointer"></div>
        <div class="roulette-inner">
          <div class="roulette-number" id="roulette-number">--</div>
          <div class="roulette-label">ç§’</div>
        </div>
      </div>
      <div class="roulette-message" id="roulette-message">
        ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ã€å¥½ããªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¹ãƒˆãƒƒãƒ—ã—ã‚ˆã†ï¼
      </div>

      <div class="btn-inline-group" style="margin-top: 14px">
        <button class="btn" id="roulette-start-btn">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button class="btn btn-secondary" id="roulette-stop-btn" disabled>
          ã‚¹ãƒˆãƒƒãƒ—ï¼
        </button>
      </div>

      <div style="margin-top: 10px">
        <button class="btn btn-secondary" id="roulette-decide-btn" disabled>
          ã“ã®ãŠé¡Œã§ã‚²ãƒ¼ãƒ é–‹å§‹ â–¶
        </button>
      </div>
    </section>

    <!-- ãƒ—ãƒ¬ã‚¤ç”»é¢ -->
    <section id="game-screen" class="hidden">
      <div class="status-line">
        <span id="round-status"></span>
      </div>
      <div class="current-player" id="current-player-label"></div>

      <div class="target-box">
        ãŠé¡Œï¼š<span id="target-seconds">--</span> ç§’ ã‚­ãƒƒãƒãƒªã§æ­¢ã‚ã‚ˆã†ï¼
      </div>

      <p class="instruction">
        ã€Œã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦å¿ƒã®ä¸­ã§ç§’ã‚’æ•°ãˆã€ã¡ã‚‡ã†ã©ã ã¨æ€ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€Œã‚¹ãƒˆãƒƒãƒ—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
        ã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒã®æ•°å­—ã¯æ­¢ã‚ã‚‹ã¾ã§è¦‹ãˆã¾ã›ã‚“ã€‚
      </p>

      <div class="btn-inline-group">
        <button class="btn" id="start-timer-btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button class="btn btn-secondary" id="stop-timer-btn" disabled>
          ã‚¹ãƒˆãƒƒãƒ—
        </button>
      </div>

      <div class="result-box" id="round-result">
        ã¾ã è¨ˆæ¸¬ã—ã¦ã„ã¾ã›ã‚“ã€‚
      </div>

      <div style="margin-top: 10px">
        <button class="btn btn-secondary" id="next-player-btn" disabled>
          æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ â–¶
        </button>
      </div>
    </section>

    <!-- çµæœç™ºè¡¨ç”»é¢ -->
    <section id="result-screen" class="hidden">
      <div class="result-header">
        <div class="badge">ğŸ‰ çµæœç™ºè¡¨ ğŸ‰</div>
        <div class="winner-title">æœ€ã‚‚èª¤å·®ãŒå°‘ãªã‹ã£ãŸã®ã¯â€¦</div>
        <div class="confetti">
          <span></span><span></span><span></span><span></span><span></span>
        </div>
        <div class="winner-name" id="winner-name-label">
          ï¼Ÿï¼Ÿã•ã‚“
        </div>
        <div class="winner-caption" id="winner-caption"></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>é †ä½</th>
            <th>åå‰</th>
            <th>ãŠé¡Œ</th>
            <th>çµæœ</th>
            <th>èª¤å·®</th>
          </tr>
        </thead>
        <tbody id="score-table-body"></tbody>
      </table>

      <div class="footer-buttons">
        <button class="btn" id="play-again-btn">ã‚‚ã†ä¸€åº¦ã‚ãã¶</button>
        <button class="btn btn-secondary" id="back-to-setup-btn">
          äººæ•°ãƒ»åå‰ã‚’å¤‰ãˆã‚‹
        </button>
      </div>
    </section>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const setupScreen = document.getElementById("setup-screen");
      const rouletteScreen = document.getElementById("roulette-screen");
      const gameScreen = document.getElementById("game-screen");
      const resultScreen = document.getElementById("result-screen");

      const playerCountSelect = document.getElementById("player-count");
      const namesGrid = document.getElementById("names-grid");
      const startGameBtn = document.getElementById("start-game-btn");

      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆè¦ç´ 
      const rouletteNumberEl = document.getElementById("roulette-number");
      const rouletteMessageEl = document.getElementById("roulette-message");
      const rouletteStartBtn = document.getElementById("roulette-start-btn");
      const rouletteStopBtn = document.getElementById("roulette-stop-btn");
      const rouletteDecideBtn = document.getElementById("roulette-decide-btn");

      // ã‚²ãƒ¼ãƒ è¦ç´ 
      const roundStatus = document.getElementById("round-status");
      const currentPlayerLabel = document.getElementById(
        "current-player-label"
      );
      const targetSecondsSpan = document.getElementById("target-seconds");
      const startTimerBtn = document.getElementById("start-timer-btn");
      const stopTimerBtn = document.getElementById("stop-timer-btn");
      const roundResultBox = document.getElementById("round-result");
      const nextPlayerBtn = document.getElementById("next-player-btn");

      const winnerNameLabel = document.getElementById("winner-name-label");
      const winnerCaption = document.getElementById("winner-caption");
      const scoreTableBody = document.getElementById("score-table-body");
      const playAgainBtn = document.getElementById("play-again-btn");
      const backToSetupBtn = document.getElementById("back-to-setup-btn");

      const MIN_SECONDS = 5;
      const MAX_SECONDS = 20;

      let players = [];
      let currentIndex = 0;
      let targetSeconds = null; // å…¨å“¡å…±é€šã®ãŠé¡Œç§’æ•°
      let timerRunning = false;
      let startTime = null;

      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆç”¨
      let rouletteRunning = false;
      let rouletteTimer = null;
      let rouletteValue = MIN_SECONDS;

      function updateNameInputsVisibility() {
        const count = parseInt(playerCountSelect.value, 10);
        const rows = namesGrid.querySelectorAll(".name-row");
        rows.forEach((row) => {
          const idx = parseInt(row.dataset.index, 10);
          row.style.display = idx <= count ? "flex" : "none";
        });
      }

      function formatSeconds(seconds) {
        return seconds.toFixed(2);
      }

      function showScreen(screen) {
        setupScreen.classList.add("hidden");
        rouletteScreen.classList.add("hidden");
        gameScreen.classList.add("hidden");
        resultScreen.classList.add("hidden");
        screen.classList.remove("hidden");
      }

      function initPlayers() {
        const numPlayers = parseInt(playerCountSelect.value, 10);
        players = [];
        for (let i = 1; i <= numPlayers; i++) {
          const input = document.getElementById(`player-name-${i}`);
          const name = (input.value || "").trim() || `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i}`;
          players.push({
            name,
            target: null,
            actual: null,
            diff: null,
          });
        }
      }

      /* ===== ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–¢é€£ ===== */

      function resetRoulette() {
        if (rouletteTimer) {
          clearInterval(rouletteTimer);
          rouletteTimer = null;
        }
        rouletteRunning = false;
        rouletteValue = MIN_SECONDS;
        rouletteNumberEl.textContent = "--";
        rouletteMessageEl.textContent =
          "ã€Œãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ã€å¥½ããªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚¹ãƒˆãƒƒãƒ—ã—ã‚ˆã†ï¼";
        rouletteStartBtn.disabled = false;
        rouletteStopBtn.disabled = true;
        rouletteDecideBtn.disabled = true;
        targetSeconds = null;
      }

      function startRoulette() {
        if (rouletteRunning) return;
        rouletteRunning = true;
        rouletteStartBtn.disabled = true;
        rouletteStopBtn.disabled = false;
        rouletteDecideBtn.disabled = true;
        rouletteMessageEl.textContent =
          "å›è»¢ä¸­â€¦ ãƒ”ãƒƒã‚¿ãƒªã‚’ç‹™ã£ã¦ã‚¹ãƒˆãƒƒãƒ—ã—ã¦ã­ï¼";

        // ãƒ©ãƒ³ãƒ€ãƒ ãª 5ã€œ20 ç§’ã‚’é«˜é€Ÿã§è¡¨ç¤º
        rouletteTimer = setInterval(() => {
          const range = MAX_SECONDS - MIN_SECONDS + 1;
          rouletteValue =
            MIN_SECONDS + Math.floor(Math.random() * range); // ãƒ©ãƒ³ãƒ€ãƒ 
          rouletteNumberEl.textContent = rouletteValue;
        }, 40); // é«˜é€Ÿå›è»¢
      }

      function stopRoulette() {
        if (!rouletteRunning) return;
        rouletteRunning = false;
        if (rouletteTimer) {
          clearInterval(rouletteTimer);
          rouletteTimer = null;
        }
        targetSeconds = rouletteValue;
        rouletteStopBtn.disabled = true;
        rouletteStartBtn.disabled = false;
        rouletteDecideBtn.disabled = false;

        rouletteMessageEl.textContent = `ãŠé¡Œã¯ ${targetSeconds} ç§’ï¼ã€Œã“ã®ãŠé¡Œã§ã‚²ãƒ¼ãƒ é–‹å§‹ã€ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼`;
      }

      function decideRoulette() {
        if (targetSeconds == null) return;
        currentIndex = 0;
        showScreen(gameScreen);
        setupRoundForCurrentPlayer();
      }

      /* ===== ã‚²ãƒ¼ãƒ é–¢é€£ ===== */

      function setupRoundForCurrentPlayer() {
        timerRunning = false;
        startTime = null;

        const player = players[currentIndex];
        const numPlayers = players.length;

        roundStatus.textContent = `ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ ${currentIndex + 1} / ${numPlayers}`;
        currentPlayerLabel.textContent = `${player.name} ã•ã‚“ã®ç•ªã§ã™`;

        targetSecondsSpan.textContent = targetSeconds ?? "--";

        startTimerBtn.disabled = false;
        stopTimerBtn.disabled = true;
        nextPlayerBtn.disabled = true;

        roundResultBox.innerHTML = "ã¾ã è¨ˆæ¸¬ã—ã¦ã„ã¾ã›ã‚“ã€‚";
      }

      function handleStartTimer() {
        if (timerRunning || rouletteRunning) return;
        if (targetSeconds == null) return;
        timerRunning = true;
        startTime = performance.now();
        startTimerBtn.disabled = true;
        stopTimerBtn.disabled = false;
        nextPlayerBtn.disabled = true;

        roundResultBox.innerHTML = "ã‚«ã‚¦ãƒ³ãƒˆä¸­â€¦ å¿ƒã®ä¸­ã§ç§’ã‚’æ•°ãˆã¾ã—ã‚‡ã†ã€‚";
      }

      function handleStopTimer() {
        if (!timerRunning) return;
        timerRunning = false;
        stopTimerBtn.disabled = true;

        const endTime = performance.now();
        const elapsedMs = endTime - startTime;
        const elapsedSeconds = elapsedMs / 1000;
        const diffSeconds = Math.abs(elapsedSeconds - targetSeconds);

        const player = players[currentIndex];
        player.target = targetSeconds;
        player.actual = elapsedSeconds;
        player.diff = diffSeconds;

        const actualText = formatSeconds(elapsedSeconds);
        const diffText = formatSeconds(diffSeconds);

        const fasterOrSlower =
          elapsedSeconds > targetSeconds ? "ï¼ˆå°‘ã—é…ã‚ã§ã—ãŸï¼‰" : "ï¼ˆå°‘ã—æ—©ã‚ã§ã—ãŸï¼‰";

        roundResultBox.innerHTML = `
          <div class="result-highlight">
            è¨ˆæ¸¬çµæœï¼š${actualText} ç§’
          </div>
          <div class="result-sub">
            ãŠé¡Œï¼š${targetSeconds} ç§’ ï¼ èª¤å·®ï¼š${diffText} ç§’ ${
          diffSeconds === 0 ? "âœ¨ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼" : fasterOrSlower
        }
          </div>
        `;

        nextPlayerBtn.textContent =
          currentIndex === players.length - 1
            ? "çµæœç™ºè¡¨ã¸ â–¶"
            : "æ¬¡ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¸ â–¶";
        nextPlayerBtn.disabled = false;
      }

      function handleNextPlayer() {
        if (currentIndex < players.length - 1) {
          currentIndex++;
          setupRoundForCurrentPlayer();
        } else {
          showResultScreen();
        }
      }

      function showResultScreen() {
        const ranked = players
          .map((p, idx) => ({ ...p, index: idx }))
          .sort((a, b) => a.diff - b.diff);

        const best = ranked[0];
        const bestDiffText = formatSeconds(best.diff);
        const bestActualText = formatSeconds(best.actual);

        winnerNameLabel.textContent = `${best.name} ã•ã‚“ã®å‹åˆ©ï¼`;
        winnerCaption.textContent = `ãŠé¡Œ ${
          best.target
        } ç§’ã«å¯¾ã—ã¦ã€${bestActualText} ç§’ï¼ˆèª¤å·® ${bestDiffText} ç§’ï¼‰ã¨ã„ã†é©šç•°ã®ç²¾åº¦ã§ã—ãŸï¼`;

        scoreTableBody.innerHTML = "";
        ranked.forEach((p, i) => {
          const tr = document.createElement("tr");
          if (i === 0) tr.classList.add("highlight");
          const rank = i + 1;
          const t = formatSeconds(p.actual);
          const d = formatSeconds(p.diff);
          tr.innerHTML = `
            <td>${rank}</td>
            <td>${p.name}</td>
            <td>${p.target} ç§’</td>
            <td>${t} ç§’</td>
            <td>${d} ç§’</td>
          `;
          scoreTableBody.appendChild(tr);
        });

        showScreen(resultScreen);
      }

      function resetToGameSamePlayers() {
        players = players.map((p) => ({
          ...p,
          target: null,
          actual: null,
          diff: null,
        }));
        targetSeconds = null;
        currentIndex = 0;
        showScreen(rouletteScreen);
        resetRoulette();
      }

      function resetToSetup() {
        if (rouletteTimer) {
          clearInterval(rouletteTimer);
          rouletteTimer = null;
        }
        targetSeconds = null;
        showScreen(setupScreen);
      }

      /* ===== ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š ===== */

      playerCountSelect.addEventListener("change", updateNameInputsVisibility);

      startGameBtn.addEventListener("click", () => {
        initPlayers();
        showScreen(rouletteScreen);
        resetRoulette();
      });

      rouletteStartBtn.addEventListener("click", startRoulette);
      rouletteStopBtn.addEventListener("click", stopRoulette);
      rouletteDecideBtn.addEventListener("click", decideRoulette);

      startTimerBtn.addEventListener("click", handleStartTimer);
      stopTimerBtn.addEventListener("click", handleStopTimer);
      nextPlayerBtn.addEventListener("click", handleNextPlayer);

      playAgainBtn.addEventListener("click", resetToGameSamePlayers);
      backToSetupBtn.addEventListener("click", resetToSetup);

      // åˆæœŸè¡¨ç¤º
      updateNameInputsVisibility();
      showScreen(setupScreen);
    });
  </script>
</body>
</html>
